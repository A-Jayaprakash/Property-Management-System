<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Property Management System</title>
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <!-- This section is for the header of property CRUD module -->
      <div class="header">
        <h1>Property Management System</h1>
        <p>Manage your properties efficiently and effectively</p>
      </div>

      <!-- This section is for the actions which can be performed by the user in the property CRUD module -->
      <div class="actions-bar">
        <!-- This is the search box -->
        <div class="search-box">
          <input
            type="text"
            id="searchInput"
            placeholder="Search properties..."
          />
        </div>

        <!-- This is the flex box which holds the Theme and Add button -->
        <div style="display: flex; gap: 15px; align-items: center">
          <!-- Theme Button -->
          <button
            class="btn theme-toggle-btn"
            id="themeToggle"
            onclick="toggleTheme()"
            title="Toggle Theme"
          >
            <span id="themeIcon">ðŸŒ™</span>
            <span id="themeText">Dark Mode</span>
          </button>

          <!-- Add Property Button -->
          <button class="btn btn-primary" onclick="openAddModal()">
            âž• Add New Property
          </button>
        </div>
      </div>

      <div id="errorMessage" class="error-message"></div>
      <div id="successMessage" class="success-message"></div>

      <div id="loadingIndicator" class="loading">Loading properties...</div>

      <div id="propertiesContainer" class="properties-grid"></div>
    </div>

    <!-- Add/Edit Property Modal -->
    <div id="propertyModal" class="modal">
      <div class="modal-content">
        <!-- Modal Header -->
        <div class="modal-header">
          <h2 id="modalTitle">Add New Property</h2>
          <span class="close" onclick="closeModal()">&times;</span>
        </div>

        <div class="modal-body">
          <form id="propertyForm">
            <div class="form-group">
              <label for="propertyName">Property Name *</label>
              <input type="text" id="propertyName" name="name" required />
            </div>

            <div class="form-group">
              <label for="propertyAddress">Address *</label>
              <input type="text" id="propertyAddress" name="address" required />
            </div>

            <div class="form-group">
              <label for="propertyLocality">Locality</label>
              <input type="text" id="propertyLocality" name="locality" />
            </div>

            <div class="form-group">
              <label for="propertyType">Property Type *</label>
              <select id="propertyType" name="type" required>
                <option value="">Select Type</option>
                <option value="Residential">Residential</option>
                <option value="Commercial">Commercial</option>
              </select>
            </div>

            <div class="form-group">
              <label for="unitCount">Unit Count *</label>
              <input
                type="number"
                id="unitCount"
                name="unitCount"
                min="1"
                required
              />
            </div>

            <div
              style="
                display: flex;
                gap: 15px;
                justify-content: flex-end;
                margin-top: 30px;
              "
            >
              <button
                type="button"
                class="btn btn-secondary"
                onclick="closeModal()"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-success" id="submitBtn">
                Save Property
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let properties = [];
      let currentEditId = null;
      let isAuthenticated = false;
      let authToken = null;

      // Better API URL detection
      const getAPIBaseURL = () => {
        if (
          window.location.hostname === "localhost" ||
          window.location.hostname === "127.0.0.1"
        ) {
          return "http://localhost:3000/api/properties";
        } else {
          // For production, use the same origin
          return `${window.location.protocol}//${window.location.host}/api/properties`;
        }
      };

      const API_BASE_URL = getAPIBaseURL();

      console.log("API Base URL:", API_BASE_URL);

      // Function to get auth headers for API calls
      function getAuthHeaders() {
        const token = sessionStorage.getItem("authToken");
        if (!token) {
          throw new Error("No authentication token found");
        }
        return {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        };
      }

      // Function to check authentication
      function checkAuthentication() {
        const token = sessionStorage.getItem("authToken");
        const userDataStr = sessionStorage.getItem("userData");

        if (!token || !userDataStr) {
          console.log("No authentication data found, redirecting to login");
          window.location.href = "login.html";
          return false;
        }

        try {
          const userData = JSON.parse(userDataStr);

          // Store globally for easy access
          authToken = token;
          window.userData = {
            token: token,
            user: userData,
          };

          isAuthenticated = true;
          return true;
        } catch (error) {
          console.error("Error parsing user data:", error);
          // Clear invalid data and redirect to login
          sessionStorage.removeItem("authToken");
          sessionStorage.removeItem("userData");
          window.location.href = "login.html";
          return false;
        }
      }

      // Function to verify token validity (optional, can be called separately)
      async function verifyTokenValidity() {
        if (!authToken) {
          console.log("No token to verify");
          return false;
        }

        try {
          const response = await fetch(API_BASE_URL, {
            method: "GET",
            headers: getAuthHeaders(),
          });

          if (!response.ok) {
            throw new Error("Token invalid or expired");
          }

          console.log("Token verified successfully");
          return true;
        } catch (error) {
          console.error("Token verification failed:", error);
          // Clear invalid token and redirect to login
          sessionStorage.removeItem("authToken");
          sessionStorage.removeItem("userData");
          window.location.href = "login.html";
          return false;
        }
      }

      // Logout function
      function logout() {
        sessionStorage.removeItem("authToken");
        sessionStorage.removeItem("userData");
        authToken = null;
        isAuthenticated = false;
        window.location.href = "login.html";
      }

      // Enhanced load properties function with proper error handling
      async function loadProperties() {
        if (!isAuthenticated) {
          console.log("Not authenticated, cannot load properties");
          return;
        }

        const loadingIndicator = document.getElementById("loadingIndicator");
        const errorMessage = document.getElementById("errorMessage");
        const successMessage = document.getElementById("successMessage");

        try {
          // Show loading
          if (loadingIndicator) {
            loadingIndicator.style.display = "block";
          }

          // Clear previous messages
          if (errorMessage) {
            errorMessage.style.display = "none";
            errorMessage.textContent = "";
          }
          if (successMessage) {
            successMessage.style.display = "none";
            successMessage.textContent = "";
          }

          console.log(
            "Loading properties with token:",
            authToken ? "Present" : "Missing"
          );

          const response = await fetch(API_BASE_URL, {
            method: "GET",
            headers: getAuthHeaders(),
          });

          if (!response.ok) {
            if (response.status === 401) {
              throw new Error("Authentication failed. Please login again.");
            }
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          properties = data || [];

          console.log("Properties loaded successfully:", properties.length);

          // Call render function if it exists
          if (typeof renderProperties === "function") {
            renderProperties(properties);
          }

          // Hide loading
          if (loadingIndicator) {
            loadingIndicator.style.display = "none";
          }
        } catch (error) {
          console.error("Error loading properties:", error);

          // Hide loading
          if (loadingIndicator) {
            loadingIndicator.style.display = "none";
          }

          // Show error message
          if (errorMessage) {
            errorMessage.textContent = `Failed to load properties: ${error.message}`;
            errorMessage.style.display = "block";
          }

          // If authentication error, redirect to login
          if (
            error.message.includes("Authentication failed") ||
            error.message.includes("No token provided") ||
            error.message.includes("No authentication token found")
          ) {
            setTimeout(() => {
              logout();
            }, 2000);
          }
        }
      }

      // Initialize the application
      document.addEventListener("DOMContentLoaded", async function () {
        console.log("DOM loaded, initializing application");

        // First, check authentication
        if (!checkAuthentication()) {
          return; // Will redirect to login
        }

        console.log("Authentication check passed, loading properties");

        // Load properties after authentication is confirmed
        await loadProperties();

        // Setup other listeners
        setupSearchListener();
        setupFormListener();
        initializeTheme();
      });

      // Modal click handler
      window.onclick = function (event) {
        const modal = document.getElementById("propertyModal");
        if (event.target === modal) {
          closeModal();
        }
      };

      // Enhanced API call wrapper with authentication
      async function makeAuthenticatedRequest(url, options = {}) {
        if (!isAuthenticated) {
          throw new Error("Not authenticated");
        }

        const defaultOptions = {
          headers: getAuthHeaders(),
        };

        const mergedOptions = {
          ...defaultOptions,
          ...options,
          headers: {
            ...defaultOptions.headers,
            ...options.headers,
          },
        };

        const response = await fetch(url, mergedOptions);

        if (!response.ok) {
          if (response.status === 401) {
            // Token expired or invalid
            logout();
            throw new Error("Authentication expired. Please login again.");
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        return response;
      }

      // Example usage for other API calls (you can use this pattern in your other script files)
      async function createProperty(propertyData) {
        try {
          const response = await makeAuthenticatedRequest(API_BASE_URL, {
            method: "POST",
            body: JSON.stringify(propertyData),
          });
          return await response.json();
        } catch (error) {
          console.error("Error creating property:", error);
          throw error;
        }
      }

      async function updateProperty(id, propertyData) {
        try {
          const response = await makeAuthenticatedRequest(
            `${API_BASE_URL}/${id}`,
            {
              method: "PUT",
              body: JSON.stringify(propertyData),
            }
          );
          return await response.json();
        } catch (error) {
          console.error("Error updating property:", error);
          throw error;
        }
      }

      async function deleteProperty(id) {
        try {
          const response = await makeAuthenticatedRequest(
            `${API_BASE_URL}/${id}`,
            {
              method: "DELETE",
            }
          );
          return await response.json();
        } catch (error) {
          console.error("Error deleting property:", error);
          throw error;
        }
      }

      // Add a logout button functionality (you can add this to your UI)
      function addLogoutButton() {
        // This is optional - you can add a logout button to your UI
        const logoutBtn = document.createElement("button");
        logoutBtn.textContent = "Logout";
        logoutBtn.onclick = logout;
        logoutBtn.style.cssText = `
          position: fixed;
          top: 10px;
          right: 10px;
          background: #dc3545;
          color: white;
          border: none;
          padding: 8px 16px;
          border-radius: 4px;
          cursor: pointer;
          z-index: 1000;
        `;
        document.body.appendChild(logoutBtn);
      }
    </script>
    <script src="escapeHTML.js"></script>
    <script src="showLoading.js"></script>
    <script src="showError.js"></script>
    <script src="showSuccess.js"></script>
    <script src="openModal.js"></script>
    <script src="closeModal.js"></script>
    <script src="formListener.js"></script>
    <script src="formSubmit.js"></script>
    <script src="searchListener.js"></script>
    <script src="filterProperties.js"></script>
    <script src="loadProperties.js"></script>
    <script src="deleteProperty.js"></script>
    <script src="renderProperties.js"></script>
    <script src="editProperty.js"></script>
    <script src="toggleTheme.js"></script>
  </body>
</html>
